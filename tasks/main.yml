---
# tasks file for rsyslog

- name: Import assert.yml
  ansible.builtin.import_tasks:
    file: assert.yml
  run_once: true
  delegate_to: localhost

- name: Uninstall conflicting systemd-logger
  ansible.builtin.package:
    name: systemd-logger
    state: absent

- name: Install rsyslog
  ansible.builtin.package:
    name: "{{ rsyslog_packages }}"
    state: "{{ rsyslog_package_state }}"

- name: Install additional rsyslog packages
  ansible.builtin.package:
    name: "rsyslog-{{ item }}"
    state: "{{ rsyslog_package_state }}"
  loop: "{{ rsyslog_features }}"

- name: Configuring default rsyslog
  ansible.builtin.template:
    src: "{{ rsyslog_config_file_format }}_rsyslog.conf.j2"
    dest: "{{ rsyslog_dest_conf_file }}"
    owner: "{{ rsyslog_config_owner }}"
    group: "{{ rsyslog_config_group }}"
    mode: "{{ rsyslog_config_mode }}"
  when:
    - rsyslog_deploy_default_config
  notify:
    - Restart rsyslog

- name: Make configuration directory
  ansible.builtin.file:
    name: /etc/rsyslog.d/
    state: directory
    owner: "{{ rsyslog_config_owner }}"
    group: "{{ rsyslog_config_group }}"
    mode: "{{ rsyslog_config_dir_mode }}"

- name: Configuring rsyslog forward rule
  ansible.builtin.template:
    src: "forward_rule.conf.j2"
    dest: /etc/rsyslog.d/{{ rsyslog_forward_rule_name }}.conf
    owner: "{{ rsyslog_config_owner }}"
    group: "{{ rsyslog_config_group }}"
    mode: "{{ rsyslog_config_mode }}"
  when:
    - not rsyslog_deploy_default_config
    - rsyslog_remote is defined
  notify:
    - Restart rsyslog

- name: Configuring additional config files
  ansible.builtin.copy:
    content: "{{ item.content | default('') }}"
    dest: "/etc/rsyslog.d/{{ item.name }}.conf"
    validate: "{{ 'rsyslogd -N1 -f %s' if item.validate | default(false) else 'true %s' }}"
    owner: "{{ rsyslog_config_owner }}"
    group: "{{ rsyslog_config_group }}"
    mode: "{{ rsyslog_config_mode }}"
  loop: "{{ rsyslog_rsyslog_d_files }}"
  when:
    - item.state | default('present') == 'present'
  notify:
    - Restart rsyslog

- name: Start and enable rsyslog
  block:
    - name: Start and enable rsyslog service
      ansible.builtin.service:
        name: "{{ rsyslog_service }}"
        state: started
        enabled: true
  rescue:
    - name: Get rsyslog journal logs after service start failure
      ansible.builtin.command:
        cmd: journalctl -u {{ rsyslog_service }} -n 200 --no-pager
      register: rsyslog_journal
      changed_when: false
      ignore_errors: true

    - name: Fail with journal output
      ansible.builtin.fail:
        msg: >-
          rsyslog service failed to start (e.g. timeout).
          Journal output:
          {{ rsyslog_journal.stdout | default('(journalctl unavailable or no output)') }}
